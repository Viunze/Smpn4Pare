<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8"><script>
    // KRITIS: Pastikan URL ini menunjuk ke Railway
    const SERVER_URL = 'https://smpn4pare-production.up.railway.app'; 

    const displayStatus = (id, message, type) => {
        // ... (Kode displayStatus Anda)
    };

    // --- Handle Registrasi ---
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        // ... (Payload Anda)
        const payload = {
            nama_lengkap: document.getElementById('reg-nama').value,
            username: document.getElementById('reg-username').value,
            password: document.getElementById('reg-password').value,
            kelas: document.getElementById('reg-kelas').value
        };

        try {
            const response = await fetch(`${SERVER_URL}/api/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // Logika validasi respons (sama seperti sebelumnya, memastikan respons bukan HTML error)
            const contentType = response.headers.get('content-type');
            let data = {};
            // ... (Logika penanganan non-JSON)
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
            } else {
                const text = await response.text();
                // Jika server tidak OK, kita berasumsi ada pesan error di text/data
                try {
                    data = JSON.parse(text); 
                } catch (e) {
                    data.msg = `Registrasi gagal. Server merespons tidak terduga. (Status: ${response.status})`;
                }
            }
            // ... (Akhir logika penanganan non-JSON)

            if (response.ok) {
                // KRITIS: Periksa apakah token dan user ada di respons backend
                if (data.token && data.user) {
                    displayStatus('register-message', 'Registrasi Berhasil! Mengalihkan ke forum.', 'success');
                    
                    // LINGKARAN MERAH SUDAH DIHENTIKAN DI SINI:
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    setTimeout(() => {
                        window.location.href = 'chat_forum.html'; 
                    }, 1500);

                } else {
                    // Jika registrasi OK tapi token hilang, hentikan redirect.
                    displayStatus('register-message', 'Registrasi OK, tapi data sesi hilang. Cek backend!', 'error');
                    console.error('SERVER ERROR: Token atau user hilang di respons 200 OK.');
                }
            } else {
                // LOGIKA GAGAL (Response status 4xx/5xx)
                displayStatus('register-message', data.msg || 'Registrasi gagal. Username mungkin sudah terdaftar.', 'error');
            }

        } catch (err) {
            // ... (Logika penanganan error jaringan/CORS)
        }
    });

    // --- Handle Login (Harusnya juga diperbaiki) ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        // ... Logika login Anda di sini (Pastikan login juga menyimpan token/user)
    });
</script>
